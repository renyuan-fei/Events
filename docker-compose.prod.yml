version: "3.4"

services:
  webapi:
    image: arandomname/webapi                               # Image name to use
    platform: linux/amd64                                   # Platform setting
    build:                                                  # Build information
      context: .                                            # Build context directory
      dockerfile: src/WebAPI/Dockerfile                     # Path to the Dockerfile
    environment:                                            # Environment variables
      - UseInMemoryDatabase=false                           # Whether to use an in-memory database
      - ConnectionStrings__EventsConnection=Server=db;Port=5432;Database=Events;User Id=postgres;Password=${DB_PASSWORD};SSL Mode=Prefer;Trust Server Certificate=true
      - ASPNETCORE_URLS=http://+:80
      - ASPNETCORE_ENVIRONMENT=Development                   # ASP.NET Core environment
      - IdentityServer__Key__Type=Development                # IdentityServer key type
      - Cloudinary__CloudName=${CLOUDINARY_CLOUD_NAME}
      - Cloudinary__ApiKey=${CLOUDINARY_API_KEY}
      - Cloudinary__ApiSecret=${CLOUDINARY_API_SECRET}
    ports:                                                  # Port mappings
      - "7095:443"
      - "7096:80"
    depends_on:                                             # Service dependencies
      - db
    restart: unless-stopped                                 # Restart policy

  db:
    image: postgres:latest                                  # PostgreSQL image
    platform: linux/amd64
    environment:                                            # PostgreSQL environment variables
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=Events
      - POSTGRES_USER=postgres
    volumes:                                                # PostgreSQL data volumes
      - postgres_data:/var/lib/postgresql/data
    ports:                                                  # PostgreSQL port mappings
      - "5432:5432"
    restart: unless-stopped

volumes:
  postgres_data: {}                                         # PostgreSQL volume definition
  data_protection_keys: {}                                  # Data protection keys volume definition
